#!/usr/bin/sh

# bleUX, a user-centric desktop Linux distribution
# Copyright (C) 2023, 2024  Natan Junges <natanajunges@gmail.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -e -x

if [ -n "$UPGRADE" ]; then
    # Store old kernel version
    OLD_VERSION=$(dpkg -s linux-headers-generic-hwe-22.04 | grep ^Depends: | cut -d- -f3-4)
fi

# Remove restricted repository
add-apt-repository -y -n --remove restricted

# Install bleUX repository
if [ ! -d /usr/local/bleux/ ]; then
    wget https://github.com/natanjunges/bleux/releases/latest/download/bleux-repository.deb
    apt-get install -y ./bleux-repository.deb
fi

# Install nala repository
wget https://deb.volian.org/volian/pool/main/v/volian-archive/volian-archive-keyring_0.3.1_all.deb \
     https://deb.volian.org/volian/pool/main/v/volian-archive/volian-archive-nala_0.3.1_all.deb
apt-get install -y --mark-auto ./volian-archive-keyring_*_all.deb ./volian-archive-nala_*_all.deb
apt-mark hold volian-archive-nala
mv /etc/apt/sources.list.d/volian-archive-nala-unstable.sources /etc/apt/sources.list.d/volian-archive-nala-unstable.sources.disabled

# Add universe repository
add-apt-repository -y universe

# Purge restricted software
apt-get purge -y firmware-sof-signed

# Purge transitional packages
apt-get purge -y firefox gstreamer1.0-pulseaudio libreoffice-ogltrans libreoffice-pdfimport libwmf0.2-7-gtk

# Install bleUX packages
apt-get install -y bleux-desktop

# Disable/remove features
feature remove aisleriot
feature disable apt
feature remove branding-ubuntu
feature remove cheese
feature remove desktop-icons
feature remove eog
feature remove gedit
feature remove gnome-mahjongg
feature remove gnome-mines
feature remove gnome-power-manager
feature remove gnome-sudoku
feature remove gnome-terminal
feature remove gnome-todo
feature remove libreoffice
feature remove pulseaudio
feature remove remmina
feature remove rhythmbox
feature remove seahorse
feature remove shotwell
feature remove snap
feature remove thunderbird
feature remove transmission
feature remove ubuntu-dock

# Add features
feature add flatpak
feature add flatpak firefox
feature add flatpak libreoffice
feature add flatpak loupe
feature add flatpak snapshot
feature add flatpak thunderbird
feature add flatpak transmission
feature add gnome-connections
feature add gnome-console
feature add gnome-music
feature add gnome-software
feature add gnome-text-editor
feature add nala
feature add pipewire

# Purge unused packages
apt-get autoremove -y --purge

if [ -n "$UPGRADE" ]; then
    # Upgrade all packages
    apt-get dist-upgrade -y

    # Store new kernel version
    NEW_VERSION=$(dpkg -s linux-headers-generic-hwe-22.04 | grep ^Depends: | cut -d- -f3-4)

    # Decide if it needs to purge an older kernel version
    if [ $OLD_VERSION != $NEW_VERSION ]; then
        apt-get purge -y linux-headers-$OLD_VERSION-generic linux-hwe-*-headers-$OLD_VERSION linux-image-$OLD_VERSION-generic \
                         linux-modules-$OLD_VERSION-generic linux-modules-extra-$OLD_VERSION-generic
    fi
fi

# Clean up apt cache
apt-get clean

# Autoremove this script and downloaded packages
rm customize *.deb
